# Roguelike Online - Docker Compose Configuration
# Usage: docker-compose up -d

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: roguelike_postgres
    environment:
      POSTGRES_USER: roguelike
      POSTGRES_PASSWORD: roguelike_secret
      POSTGRES_DB: roguelike
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U roguelike -d roguelike"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache/PubSub
  redis:
    image: redis:7-alpine
    container_name: roguelike_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # FastAPI Backend
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: roguelike_backend
    environment:
      - DEBUG=true
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=roguelike
      - POSTGRES_PASSWORD=roguelike_secret
      - POSTGRES_DB=roguelike
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./server:/app
      - ./src:/app/game_src  # Mount game engine for import
      - ./concept_art:/concept_art  # Mount concept art for 3D asset pipeline
      - ./jobs:/jobs  # Mount job queue for 3D generation
      - ./tools:/tools  # Mount tools for 3D pipeline worker
      - ./web/public/assets:/web_assets  # Mount output directory for generated models
      - ./.claude:/repo/.claude  # Mount Claude skills for model management
      - ./web/src/models:/repo/web/src/models  # Mount model library for set_active
    restart: unless-stopped

  # React Frontend (Vite dev server with HMR)
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: roguelike_frontend
    ports:
      - "5173:5173"
    volumes:
      - ./web:/app
      - /app/node_modules  # Preserve container's node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true  # Fallback polling flag
    restart: unless-stopped

  # 3D Model Generation Worker (TripoSR)
  3d-worker:
    build:
      context: ./tools/3d-pipeline
      dockerfile: Dockerfile
    container_name: roguelike_3d_worker
    volumes:
      - ./jobs:/jobs  # Job queue (shared with backend)
      - ./concept_art:/concept_art  # Source images
      - ./web/public/assets/models:/web_assets/models  # Generated output
      - triposr_models:/models  # Huggingface model cache
    environment:
      - HF_HOME=/models
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  triposr_models:  # Cache for Huggingface TripoSR model
